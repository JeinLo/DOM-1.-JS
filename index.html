<!DOCTYPE html>
<html>
  <head>
    <title>Проект "Комменты"</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="styles.css" />
  </head>

  <body>

    
    <div id="container" class="container">

      <div id="commentHidden" class="comment comment-hidden">
        <p class="comment-text-hidden "> Комментарии загружаются ... </p>
      </div> 

      <ul id="listOfComments" class="comments"> 

        <!-- <li class="comment">
          <div class="comment-header">
            <div>Глеб Фокин</div>
            <div>12.02.22 12:18</div>
          </div>
          <div class="comment-body">
            <div class="comment-text">
              Это будет первый комментарий на этой странице
            </div>
          </div>
          <div class="comment-footer">
            <div class="likes">
              <span class="likes-counter">3</span>
              <button class="like-button"></button>
            </div>
          </div>
        </li>
        <li class="comment">
          <div class="comment-header">
            <div>Варвара Н.</div>
            <div>13.02.22 19:22</div>
          </div>
          <div class="comment-body">
            <div class="comment-text">
              Мне нравится как оформлена эта страница! ❤
            </div>
          </div>
          <div class="comment-footer">
            <div class="likes">
              <span class="likes-counter">75</span>
              <button class="like-button -active-like"></button>
            </div>
          </div>
        </li> -->
      </ul>
      <div class="add-form">
        <input id="inputName"
          type="text"
          class="add-form-name"
          placeholder="Введите ваше имя"
        />
        <textarea id="textComment"
          type="textarea"
          class="add-form-text"
          placeholder="Введите ваш коментарий"
          rows="4"
        ></textarea>
        <div class="add-form-row">
          <button id="addFormButton" class="add-form-button">Написать</button>
        </div>
        <div>
          <button id="delete-button" class="delete-form-button">Удалить последний комментарий</button>
        </div>
      </div>
    </div>
  </body>
<style>
  .error {
    background-color: red;
    }
</style>

  <script>
    "use strict";

    // элементы
   const listOfCommentsElement = document.getElementById('listOfComments');
   const addFormButtonEl = document.getElementById('addFormButton');
   const inputNameEl = document.getElementById('inputName');
   const textCommentEl = document.getElementById('textComment');
   const likeCounterEl = document.querySelectorAll('.likes-counter')
   const deleteButtonEl = document.getElementById('delete-button');
   const addFormEl = document.querySelector('add-form')
   const commentHiddenEl =  document.getElementById('commentHidden');
   

   // массив комментариев 
let comments = [ ];

// функция на получение данных из API

function getFetchPromise () {
   commentHiddenEl.classList.remove('comment-hidden');
   const fetchPromise = fetch("https://wedev-api.sky.pro/api/v1/:korotenko/comments",{
    method:"GET"
  })
    .then((response) => {
      return response.json();
    })
      .then((reponseData) => {
     const appComments = reponseData.comments.map((comment) => {
      return {
        name: comment.author.name,
        date: comment.date,
        text: comment.text,
        likeCounter: comment.likes,
        likeButton: false,
      };
      });
    comments = appComments
    commentHiddenEl.classList.add('comment-hidden');
          
    renderComments()
  });
 };
  getFetchPromise();


  // функция рендер
  const renderComments = () => {
    const commentsHtml = comments.map((comment, index) => {
      return`<li class="comment">
          <div class="comment-header">
            <div>${comment.name}</div>
            <div>${addDateTimeofComments(comment.date)}</div>
          </div>
          <div class="comment-body">
            <div class="comment-text">
              ${comment.text}
            </div>
          </div>
          <div class="comment-footer">
            <div class="likes">
              <span class="likes-counter">${comment.likeCounter}</span>
              <button class="like-button ${comment.likeButton ? '-active-like':''}" data-index='${index}'></button>     
            </div>
          </div>
        </li>` 
    })
    .join("");
    listOfCommentsElement.innerHTML = commentsHtml;
    countLikes();
    answerComment();
  }
  renderComments();
  deleteComment()

  // функция счетчика лайков
  function countLikes() {
    const likeButtonElements = document.querySelectorAll('.like-button');
    for (const likeEl of likeButtonElements) {
      likeEl.addEventListener('click', function (e) {
        e.stopPropagation();
        const index = likeEl.dataset.index;
        if(comments[index].likeButton){
          comments[index].likeButton = false;
          comments[index].likeCounter--;
        } else{
          comments[index].likeButton = true;
          comments[index].likeCounter++;
        }
        renderComments()
      });
    }
  }

  // функция удаления последнего комментария
  function deleteComment() { 
      deleteButtonEl.addEventListener('click', () => {
        comments.pop();
        renderComments();
      })
    }

   //функции неактивной кнопки
  function nonActiveButton () {
    addFormButtonEl.disabled = true;
    inputName.addEventListener('input', (event) => {
  if(event.target.value.trim === '') {
    addFormButtonEl.disabled = true;
   }else{
    addFormButtonEl.disabled = false;
  }
  })
  textCommentEl.addEventListener('input', (event) => {
  if(event.target.value.trim === '') {                   // что здесь значит target ?
    addFormButtonEl.disabled = true;
    } else {
    addFormButtonEl.disabled = false;
  }
  })
  }
   nonActiveButton();

 // функция заменяющая теги на символы в тексте
   function sanitize(text) {
      return text.replaceAll('<', '&lt;').replaceAll('>', '&gt;').replaceAll('QUOTE_BEGIN', '<div class="quote">').replaceAll('QUOTE_END', '</div>');
    }


 // функция для формата времени
   function addDateTimeofComments(commentDate) {
   let currentDate = new Date(commentDate);
   const date = { year: 'numeric', month: 'numeric', day: 'numeric'};
   const time = {hour: 'numeric', minute:'numeric'};
   let dateTimeOfCommmet = currentDate.toLocaleDateString('ru-Ru',date)+" " +currentDate.toLocaleTimeString('ru-Ru',time);
   return dateTimeOfCommmet;
 }

// обработчик кнопки написать комментарий
   addFormButtonEl.addEventListener('click', function (e) {
    e.stopPropagation();

    inputNameEl.classList.remove('error');
    textCommentEl.classList.remove('error');
    if (inputNameEl.value.trim() === '' && textCommentEl.value.trim() === '') {
      inputNameEl.classList.add('error');
      textCommentEl.classList.add('error');
      return;
    } if (inputNameEl.value.trim() === '') {
      inputNameEl.classList.add('error');
      return;
    }  else if (textCommentEl.value.trim() === '') {
      textCommentEl.classList.add('error');
      return;
    }  
    
    addFormButtonEl.disabled = true;
    addFormButtonEl.textContent = "Комментарий добавляется...";

    const postFetch = fetch("https://wedev-api.sky.pro/api/v1/:korotenko/comments",{
    method:"POST",
    body: JSON.stringify ({
      name:sanitize(inputNameEl.value),
      text:sanitize(textCommentEl.value),
    }),
  })
      .then((response) => {
      return response.json();
    })
    .then (() => {
      getFetchPromise();
      addFormButtonEl.disabled = false;
      addFormButtonEl.textContent = "Написать";
    });

    
         inputNameEl.value ="";     
         textCommentEl.value ="";
         nonActiveButton();
         renderComments();
         deleteComment();
         answerComment();
    });



     //функция ответа на комментарий
    function answerComment() {
      const commentHTML = document.querySelectorAll('.comment');
      commentHTML.forEach((el, i) => {
        el.addEventListener('click', () => {
          textCommentEl.value = `QUOTE_BEGIN ${comments[i].name}\n ${comments[i].text} QUOTE_END`;
        })
      })
    }

        //добавление комментария через enter 
  // inputNameEl.addEventListener('keyup', (event) => {
  //   if (event.which === 13) {
  //       addFormButtonEl.click();
  //       }
  //  })
  //  textCommentEl.addEventListener('keyup', (event) => {
  //   if (event.which === 13) {
  //     addFormButtonEl.click();
  //       }
  //  })

    console.log("It works!");
  </script>
</html>
