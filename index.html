<!DOCTYPE html>
<html>
  <head>
    <title>Проект "Комменты"</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="styles.css" />
  </head>

  <body>
    </div>
    <div class="container">
      <ul class="comments" id="comments-container"></ul>
      <div class="add-form">
        <input
          type="text"
          class="add-form-name"
          placeholder="Введите ваше имя"
        />
        <textarea
          type="textarea"
          class="add-form-text"
          placeholder="Введите ваш коментарий"
          rows="4"
        ></textarea>
        <div class="add-form-row">
          <button class="add-form-button">Написать</button>
          <button class="delete-form-button">
            Удалить последний комментарий
          </button>
        </div>
      </div>
    </div>
  </body>
  <style>
    .error::placeholder {
      color: red;
    }
    .disabled {
      color: gray;
    }
  </style>
  <script>
        const inputNameElement = document.querySelector(".add-form-name");
        const inputTextElement = document.querySelector(".add-form-text");
        const buttonElement = document.querySelector(".add-form-button");
        const commentElement = document.querySelector(".comments");
        const buttonElementDel = document.querySelector(".delete-form-button");
        const likeButtonsElement = document.querySelectorAll(".likes");
        const currentDate =
            new Date().toLocaleDateString("default", {
              day: "2-digit",
              month: "2-digit",
              year: "2-digit",
            }) +
            " " +
            new Date().toLocaleTimeString().slice(0, -3);
            

        // Переносим даннык из разметки
        let comments = [
          {
            name: "Глеб Фокин",
            time: "12.02.22 12:18",
            comment: "Это будет первый комментарий на этой странице",
            likes: 3,
            isLiked: false,
          },
          {
            name: "Варвара Н.",
            time: "13.02.22 19:22",
            comment: "Мне нравится как оформлена эта страница! ❤️",
            likes: 75,
            isLiked: false,
          },
        ];
      //2.12
      const getComments = () => {
      fetch("https://wedev-api.sky.pro/api/v1/tanya-s/comments", {
    method: "GET"
  }).then((response) => {
    response.json().then((responseData) => {
     comments = responseData.comments.map((comment) => {
        return {
          name: comment.author.name,
            time:  new Date().toLocaleDateString("default", {
              day: "2-digit",
              month: "2-digit",
              year: "2-digit",
            }) +
            " " +
            new Date().toLocaleTimeString().slice(0, -3),
            comment: comment.text,
            likes: comment.likes,
            isLiked: false,
        };
      });
      renderComments();
    });
  });
      };
      getComments();
     
        // рендер комментария
        const renderComments = () => {
          const commentsContainer = document.getElementById("comments-container");
          commentsContainer.innerHTML = "";
          const commentsHtml = comments
            .map((comment, index) => {
              return ` <li class="comment">
              <div class="comment-header">
                <div>${comment.name}</div>
                <div>${comment.time}</div>
              </div>
              <div class="comment-body">
                <div class="comment-text">
                  ${comment.comment}
                </div>
              </div>
              <div class="comment-footer">
                <div class="likes">
                  <span class="likes-counter">${comments[index].likes}</span>
                  <button data-index= "${index}" class="like-button ${
                comment.isLiked ? "-active-like" : ""
              }"></button>
                </div>
              </div>
            </li> `;
            })
            .join("");

          commentsContainer.innerHTML = commentsHtml;
          initEventListeners();
          answerComment();
        };

        function initEventListeners() {
          const likesElements = document.querySelectorAll(".like-button");
          for (const likesElement of likesElements) {
            likesElement.addEventListener("click", function (event) {
              event.stopPropagation();
              const index = likesElement.dataset.index;

              console.log(comments[index].likes);
              if (comments[index].isLiked) {
                comments[index].isLiked = false;
                comments[index].likes--;
              } else {
                comments[index].isLiked = true;
                comments[index].likes++;
              }
              renderComments();
            });
          }
        }

        renderComments();

        const sanitizeHtml = (htmlString) => {
    return htmlString.replaceAll("<", "&lt;").replaceAll(">", "&gt;");
  }

        //добавить коммент
        function addNewComment() {
          comments.push({
            name: inputNameElement.value
              .replaceAll("&", "&amp;")
              .replaceAll("<", "&lt;")
              .replaceAll(">", "&gt;")
              .replaceAll('"', "&quot;"),
            time: currentDate,
            comment: inputTextElement.value
              .replaceAll("<", "&lt;")
              .replaceAll(">", "&gt;")
              .replaceAll(">", "&gt;")
              .replaceAll('"', "&quot;"),
            likes: 0,
            isLiked: false,
          });
          //renderComments();
          postPromiseFetch();
        };
        function postPromiseFetch() {

      const fetchPromisePost = fetch("https://wedev-api.sky.pro/api/v1/tanya-s/comments", {
      method: "POST",
      body: JSON.stringify({
        name: sanitizeHtml(inputNameElement.value),
        text: sanitizeHtml(inputTextElement.value),
      })
    }).then((response) => {
      return response.json();

})
.then((responseData) => {
  getComments();
})
    inputNameElement.value = "";
    inputTextElement.value = "";
  };

  renderComments();

        buttonElement.addEventListener("click", () => {
          inputNameElement.classList.remove("error");
          inputTextElement.classList.remove("error");
          if (
            inputNameElement.value.trim() === "" ||
            inputTextElement.value.trim() === ""
          ) {
            inputNameElement.classList.add("error");
            inputTextElement.classList.add("error");
            return;
          }
          addNewComment();

          inputNameElement.value = "";
          inputTextElement.value = "";
        });

        //ответ на комментарий
        function answerComment() {
          const comment = document.querySelectorAll(".comment");
          const inputNameElement = document.querySelector(".add-form-name");
          const inputTextElement = document.querySelector(".add-form-text");
          comment.forEach((el, index) => {
            el.addEventListener("click", () => {
              inputTextElement.value = `${comments[index].name} \n ${comments[index].comment}`;
            });
          });
        }
        // Чтобы форма отправлялась клавишей Enter
        inputTextElement.addEventListener("keydown", function (event) {
          if (event.key === "Enter") {
            event.preventDefault();
            buttonElement.click();
          }
        });
        //Удаление последнего комментария
        buttonElementDel.addEventListener("click", () => {
      if (comments.length > 0) {
        comments.pop();
        renderComments();
      }
    });
        //console.log("It works!");*/
  </script>
</html>
