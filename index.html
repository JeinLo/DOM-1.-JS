<!DOCTYPE html>
<html>
  <head>
    <title>Проект "Комменты"</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="styles.css" />
  </head>

  <body>
    <div class="container">
      <ul id="list" class="comments"></ul>
      <div class="add-form">
        <input
          type="text"
          id="userName"
          class="add-form-name"
          placeholder="Введите ваше имя"
        />
        <textarea
          id="userComment"
          class="add-form-text"
          placeholder="Введите ваш комментарий"
          rows="4"
        ></textarea>
        <div class="add-form-row">
          <button id="writeButton" class="add-form-button">Написать</button>
        </div>
      </div>
    </div>
    <script>
      "use strict";

      const writeButton = document.getElementById("writeButton");
      const commentsList = document.getElementById("list");
      const userName = document.getElementById("userName");
      const userComment = document.getElementById("userComment");

      const API_URL =
        "https://wedev-api.sky.pro/api/v1/julia-galchenko/comments";

      let usersComments = [];

      // Получение списка комментариев из API
      fetch(API_URL, {
        method: "GET",
      })
        .then((response) => response.json())
        .then((responseData) => {
          usersComments = responseData.comments;
          renderComments();
        })
        .catch((error) => console.error("Error:", error));

        const renderComments = () => {
  const commentsHtml = usersComments.map((comment, index) => {
    return `<li class="comment" data-text="${index}">
      <div class="comment-header">
        <div>${comment.author.name}</div>
        <div>${formatDate(comment.date)}</div>
      </div>
      <div class="comment-body">
        <div class="comment-text">
          ${comment.text}
        </div>
      </div>
      <div class="comment-footer">
        <div class="likes">
          <span class="likes-counter">${comment.likes}</span>
          <button data-index="${index}" class="like-button ${comment.likeButton ? "-active-like" : ""}"></button>
        </div>
      </div>
    </li>`;
  }).join("");

  commentsList.innerHTML = commentsHtml;
  initLikesCounter();
  addReplyToComment();
};

const formatDate = (dateString) => {
  const date = new Date(dateString);
  const day = String(date.getDate()).padStart(2, '0');
  const month = String(date.getMonth() + 1).padStart(2, '0'); // Месяцы начинаются с 0
  const year = date.getFullYear();
  const hours = String(date.getHours()).padStart(2, '0');
  const minutes = String(date.getMinutes()).padStart(2, '0');
  return `${day}.${month}.${year} ${hours}:${minutes}`;
};

      const initLikesCounter = () => {
        const likeButtonsElements = document.querySelectorAll(".like-button");

        for (const likeButtonsElement of likeButtonsElements) {
          const index = likeButtonsElement.dataset.index;

          likeButtonsElement.addEventListener("click", (event) => {
            event.stopPropagation();

            usersComments[index].likeButton
              ? usersComments[index].likes -= 1
              : usersComments[index].likes += 1;
            usersComments[index].likeButton = !usersComments[index].likeButton;

            renderComments();
          });
        }
      };

      const addReplyToComment = () => {
        const commentElements = document.querySelectorAll(".comment");

        for (const comment of commentElements) {
          const index = comment.dataset.text;

          comment.addEventListener("click", () => {
            userComment.value = `> ${usersComments[index].text} \\n ${usersComments[index].author.name},`;
            userName.focus();
          });
        }
      };

      writeButton.addEventListener("click", (event) => {
        event.preventDefault();
        const currentDate = new Date();
        const actualDate = `${currentDate.getDate()}.${
          currentDate.getMonth() + 1
        }.${currentDate.getFullYear()} ${currentDate.getHours()}:${currentDate.getMinutes()}`;

        userName.classList.remove("error");
        userComment.classList.remove("error");

        if (userName.value.trim() === "" || userComment.value.trim() === "") {
          userName.classList.toggle("error", userName.value.trim() === "");
          userComment.classList.toggle("error", userComment.value.trim() === "");
          return;
        }

    const newComment = {
      author: {
      name: userName.value.replaceAll("&lt;", "&lt;").replaceAll(">", "&gt;"),
  },
      date: actualDate,
      text: userComment.value.replaceAll("<", "&lt;").replaceAll(">", "&gt;"), // Заменить < и > на &lt; и &gt;
      likes: 0,
      likeButton: false,
  };

        fetch(API_URL, {
          method: "POST",
          body: JSON.stringify({
            name: userName.value,
            text: userComment.value,
          }),
        })
          .then(() => {
            usersComments.push(newComment);
            renderComments();
            userName.value = "";
            userComment.value = "";
          })
          .catch((error) => {
            console.error("Error:", error);
            if (error.response) {
              error.response.json().then((data) => console.log(data));
            }
          });

        console.log("It works!!");
      });
    </script>
  </body>
</html>