<!DOCTYPE html>
<html>

<head>
  <title>Проект "Комменты"</title>
  <meta charset="utf-8" />
  <link rel="stylesheet" href="styles.css" />
</head>

<body>
  <div class="container">
    <div class="text" style="color:white">Комментарии загружаются...</div>
    <ul class="comments">

    </ul>
    <div class="add-form"><input type="text" class="add-form-name" placeholder="Введите ваше имя">
      <textarea type="textarea" class="add-form-text" placeholder="Введите ваш коментарий" rows="4"></textarea>
      <div class="add-form-row">
        <button class="add-form-button">Написать</button>
      </div>
    </div>
  </div>
</body>

<script>
  function escapeHTML(text) {
    return text
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#39;");
  }

  document.addEventListener("DOMContentLoaded", function () {
    let commentsData = [];

    const addButton = document.querySelector(".add-form-button");
    const nameInput = document.querySelector(".add-form-name");
    const commentInput = document.querySelector(".add-form-text");
    const commentsList = document.querySelector(".comments");
    const buttonDeleteElement = document.querySelector(".delete-form-button");
    const textDisabled = document.querySelector(".text");

    const fetchGetCommentsData = () => {
      let fetchPromise = fetch("https://wedev-api.sky.pro/api/v1/ilya-krikunenko/comments")
        .then(response => {
          if (!response.ok) {
            throw new Error('Ошибка при загрузке комментариев');
          }
          return response.json();
        })
        .then(responseData => {
          commentsData = responseData.comments.map(comment => ({
            author: comment.author.name,
            dateTime: comment.date,
            text: comment.text,
            likes: comment.likes,
            liked: comment.isLiked
          }));
          textDisabled.textContent = "";
          renderComments();
        })
        .catch(error => {
          console.error('Ошибка при загрузке комментариев:', error);
        });
    };

    // const initDeleteButtonsListeners = () => {
    //   const deleteButtonsElements = documen.querySelectorAll(".delete-form-button");
    //   for (const deleteButtonsElement of deleteButtonsElements) {
    //     deleteButtonsElement.addEventListener("click", (event) => {
    //       event.stopPropagation();
    //       commentElement.disabled = true;
    //       const index = deleteButtonsElement.dataset.index;
    //       commentData.splice(index, 1);
    //       renderComments();
    //     });
    //   }
    // };

    function renderComments() {
      const commentsList = document.querySelector(".comments");
      commentsList.innerHTML = "";

      commentsData.forEach(comment => {
        const commentElement = createCommentElement(comment);
        commentsList.appendChild(commentElement);
      });

      const commentElements = document.querySelectorAll('.comment');
      commentElements.forEach(commentElement => {
        commentElement.addEventListener('click', function () {
          const author = commentElement.querySelector('.comment-header div').innerText;
          const text = commentElement.querySelector('.comment-text').innerText;

          nameInput.value = author;
          commentInput.value = `@${author}: ${text}\n`;
          commentInput.focus();
        });
      });
    };

    function createCommentElement(comment) {
      const newComment = document.createElement("li");
      newComment.classList.add("comment");
      const likeClass = comment.liked ? " -active-like" : "";
      newComment.innerHTML = `
    <div class="comment-header">
      <div>${escapeHTML(comment.author)}</div>
      <div>${comment.dateTime}</div>
    </div>
    <div class="comment-body">
      <div class="comment-text">${escapeHTML(comment.text)}</div>
    </div>
    <div class="comment-footer">
      <button class="delete-form-button">Удалить</button>
      <div class="likes">
        <span class="likes-counter">${comment.likes}</span>
        <button class="like-button${likeClass}"></button>
      </div>
    </div>`;

      const likeButton = newComment.querySelector('.like-button');
      likeButton.addEventListener('click', function (event) {
        event.stopPropagation();
        if (comment.liked) {
          comment.likes--;
        } else {
          comment.likes++;
        }
        comment.liked = !comment.liked;
        renderComments(commentsData);
      });

      return newComment;
    };

    fetchGetCommentsData();
    renderComments(commentsData);

    addButton.addEventListener("click", function () {
      const nameValue = nameInput.value.trim();
      const commentValue = commentInput.value.trim();

      if (nameValue === "" || commentValue === "") {
        alert("Пожалуйста, введите ваше имя и комментарий!");
        return;
      }

      const newComment = {
        author: escapeHTML(nameValue),
        dateTime: getCurrentDateTime(),
        text: escapeHTML(commentValue),
        likes: 0,
        liked: false
      };

      addButton.disabled = true;
      addButton.textContent = "Комментарий добавляется"

      let fetchPromise = fetch("https://wedev-api.sky.pro/api/v1/ilya-krikunenko/comments", {
        method: "POST",
        body: JSON.stringify({
          name: nameInput.value,
          text: commentInput.value,
          date: getCurrentDateTime(new Date),
          isLiked: false,
          likes: 0,
        })
      })
        .then((response) => {
          return response.json();
        })
        .then((response) => {
          fetchGetCommentsData();
        })
        .then(() => {
          addButton.disabled = false;
          addButton.textContent = "Написать"
        })
        .catch(error => {
          console.error('Ошибка при загрузке комментариев:', error);
        });


      commentsData.push(newComment);
      renderComments(commentsData);

      nameInput.value = "";
      commentInput.value = "";
    });


    // const fetchDeleteButton = () => {
    //   fetch("https://wedev-api.sky.pro/api/v1/ilya-krikunenko/comments/" + commentId, {
    //     method: "DELETE"
    //   })
    //     .then(response => {
    //       if (!response.ok) {
    //         throw new Error("Ошибка при удалении комментария");
    //       }
    //       return response.json();
    //     })
    //     .then(responseData => {
    //       // Обновляем список комментариев после удаления
    //       fetchGetCommentsData();
    //     })
    //     .catch(error => {
    //       console.error("Ошибка при удалении комментария:", error);
    //     });
    // };

    function getCurrentDateTime() {
      const now = new Date();
      const options = { year: "numeric", month: "2-digit", day: "2-digit", hour: "2-digit", minute: "2-digit" };
      return now.toLocaleDateString("ru-RU", options);
    }
  });
</script>

</html>