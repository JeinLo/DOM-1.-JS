<!DOCTYPE html>
<html>
  <head>
    <title>Проект "Комменты"</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="styles.css" />
  </head>

  <body>
    <div class="container">
      <ul id="list" class="comments">
      </ul>
      <div id="form" class="add-form">
        <input
          id="nameInput"
          type="text"
          class="add-form-name"
          placeholder="Введите ваше имя"
        />
        <textarea
          id="commentInput"
          type="textarea"
          class="add-form-text"
          placeholder="Введите ваш коментарий"
          rows="4"
        ></textarea>
        <div class="add-form-row">
          <button disabled id="writeButton"  class="add-form-button">Написать</button>
        </div>
      </div>
    </div>

    
  </body>

  <script>
"use strict";
function MinSec() {
    let currentDate = new Date();
    let options = {hour: '2-digit', minute:'2-digit'};
    return (currentDate.toLocaleTimeString('ru-RU', options)); 
}

function Year() {
    const months = [1, 2, 3, 4, 5, 6,
        7, 8, 9, 10, 11, 12];
        let myDate = new Date();
        
        let fullDate =  myDate.getDate() +
        "." + months[myDate.getMonth()] +
        "." + myDate.getFullYear() ;
        
        return (fullDate);
        MinSec();

}
    const nameInputEl = document.getElementById('nameInput');
    const listEL = document.getElementById('list');
    const commentInputEl = document.getElementById('commentInput');
    const writeButtonEl = document.getElementById('writeButton');
      
    function getfunction() {
    const fetchCom = fetch("https://wedev-api.sky.pro/api/v1/gazim-akbutin/comments", { method: "GET"});
    fetchCom.then((res) =>{
      res.json()
      .then((resData) =>{
        const appComments = resData.comments.map((comment) => {
        return{
          name: comment.author.name,
          text: comment.text,
          date: new Date(comment.time),
          like: comment.likes,
          isLike: false,};
        });
        peoples = appComments;


        render();
      });
    });
  };

  getfunction();

     let peoples = [
    //  { name: 'Глеб Фокин',
    //   text:'Это будет первый комментарий на этой странице',
    //   time:'12.02.22 12:18',
    //   like: 3,
    //   isLike: false,
    // },{
    //   name: 'Варвара Н.',
    //   text:'Мне нравится как оформлена эта страница! ❤',
    //   time:'13.02.22 19:22',
    //   like: 75,
    //   isLike: true,}
    ];

const initEventlist = () => {     
const commentEl = document.querySelectorAll('.comment');
for (const commentEls of commentEl) {
    commentEls.addEventListener('click', () => {
      
    })
}
}

const initDeleteButton = () => {
  const deleteButtonEls = document.querySelectorAll('.deleteButton');
  for (const deleteButtonEl of deleteButtonEls) {
    deleteButtonEl.addEventListener('click', (e) => {
     const id = deleteButtonEl.dataset.id;
     peoples.splice(index, 1);

    render();
    e.stopPropagation();
    });
  }
}

const initEditButton = () => {
  const editButtonEls = document.querySelectorAll('.editButton');
  
  for (const editButtonEl of editButtonEls) {
     const index = editButtonEl.dataset.index;
    editButtonEl.addEventListener('click', (event) => {
    // peoples[index].comment = `<textarea>${peoples[index].comment}</textarea>`
    //  render();
alert('не нажимай')
   
    //  document.querySelectorAll('.editButton').textContent = 'Сохранить';

     event.stopPropagation();
    });
  }
}

const initlikeButton = () => {
  const likeButtonEls = document.querySelectorAll('.like-button');
  for (const likeButtonEl of likeButtonEls) {
    likeButtonEl.addEventListener('click', () => {
     const index = likeButtonEl.dataset.index;
     
     if (peoples[index].isLike === false || peoples[index].like === 0) {  
     peoples[index].like = parseInt(peoples[index].like) + 1; 
     peoples[index].isLike = true;
     } else {
      peoples[index].like = parseInt(peoples[index].like) - 1;
    peoples[index].isLike = false;
     }

    render();
    });
  }
}

const commetForm = () => {
  const commentBodyElements = document.querySelectorAll('.comment-body');
  for (const commentBodyElement of commentBodyElements) {
    commentBodyElement.addEventListener('click', () => {
      document.querySelector('.add-form-text').scrollIntoView({behavior: 'smooth' })
      const index = commentBodyElement.dataset.index;
      const commetandname = `${peoples[index].comment} \n${peoples[index].name}`
      commentInputEl.value = commetandname ;
      render();
    });
  }
}
commetForm();

const render = () => {
 const peopleHtml = peoples.map((people, index) => {
    return `<li data-name="${people.name}" id="com" class="comment">
          <div class="comment-header">
            <div >${people.name}</div>
            <div> ${people.time}</div>
          </div>
          <div class="comment-body" data-index="${index}">
            <div id="text" class="comment-text">
             ${people.text}
            </div>
          </div>   
          <div class="comment-footer">
            <button class="deleteButton" data-index="${index}"">Удалить</button>
            <button class="editButton" data-index="${index}"">Редактировать</button>
            <div class="likes">
              <span class="likes-counter" data-index="${index}" >${people.like}</span>
              <button class="like-button ${people.isLike ? "-active-like" : "" }"
               data-index="${index}"></button>
            </div>
          </div>
        </li>`
  }).join('');
  listEL.innerHTML = peopleHtml;
  initEventlist();
  initDeleteButton();
  initlikeButton();
  commetForm();
  initEditButton();
}

render();


    nameInputEl.addEventListener('input', function(event) {
  writeButtonEl.disabled = (nameInputEl.value === '');
});

      writeButtonEl.addEventListener('click', () => {
        setTimeout(() => { nameInputEl.classList.remove('err');}, 1000 * 0.5);
        setTimeout(() => { commentInputEl.classList.remove('err');}, 1000 * 0.5);

            if (nameInputEl.value === '') {
              nameInputEl.classList.add("err");
              return;
            }
            if (commentInputEl.value === '') {
              commentInputEl.classList.add('err');
              return;
            }
             
            if (nameInputEl.value != '') {
                
        // peoples.push({
        //       name:nameInputEl.value
        //       .replaceAll("<", "&lt;")
        //       .replaceAll(">", "&gt;"),
        //       time:Year(),
        //       text:commentInputEl.value
        //       .replaceAll("<", "&lt;")
        //       .replaceAll(">", "&gt;"),
        //       like:0
        //      });

    fetch("https://wedev-api.sky.pro/api/v1/gazim-akbutin/comments",
      {
        method: "POST",
        body: JSON.stringify({
          name:nameInputEl.value
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;"),
          text: commentInputEl.value
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;"),
          date: new Date(comment.time)  })
    });
    fetch("https://wedev-api.sky.pro/api/v1/gazim-akbutin/comments", { method: "GET"})
    .then((res) =>{
      res.json()
      .then((resData) =>{
        let appComments = resData.comments.map((comment) => {
        return{
          name: comment.author.name,
          text: comment.text,
          date: new Date(comment.time),
          like: comment.likes,
          isLike: false,};
        });
        peoples = appComments;
        render();
      });
    });


        render();
 

        this.disabled = true
        nameInputEl.value = (''); 
        commentInputEl.value = ('');
  
    }});

    console.log("It works!");
  </script>
</html>
